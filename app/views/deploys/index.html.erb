<p>
  Showing <%= @deploys.size %> deploys.
  <% if action_name == 'all' %>
    <%= link_to 'View recent', root_path %>
  <% else %>
    <%= link_to 'View all', all_deploys_path %>
  <% end %>
</p>

<% @deploys.group_by { |d| d.time.to_date }.each_pair do |date, deploys| %>
  <% deploys.each_with_index do |deploy, idx| %>
    <div class='row'>
      <div class='col-md-2'>
        <%=l date, format: :long if idx == 0 %>
      </div>
      <div class='col-md-10'>
        <div>
          <%= content_tag :a, "", name: deploy.short_ref %>
          <span class='deploy--time'>
            <%= deploy.time.to_s(:time) %>
          </span>
          <span class='deploy--sha'>
            <%= github_diff_link(deploy) %>
          </span>
          <span class='deploy--user'>
            by <%= deploy.username %>
          </span>
        </div>

        <% if deploy.missing_sha? %>
          <p>History was lost for this deploy.</p>
        <% else %>
          <ul>
            <% deploy.stories.sort_by(&:date).reverse.each do |story| %>
              <% story = StoryPresenter.new(story) %>
              <li class='story'>
                <span class='story--link'>
                  <%= ticket_link(story) %>
                </span>
                <span class='story--title'>
                  <%= story.title %>
                </span>
                <% if story.pull_request_uid %>
                  <span class='story--pr-link'>
                    <%= pull_request_link(story) %>
                  </span>
                <% end %>
                <% if story.author %>
                  <span class='story--author'>
                    <%= story.author&.email %>
                  </span>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% end %>


        <hr>
      </div>
    </div>
  <% end %>
<% end %>
